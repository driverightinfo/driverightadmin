<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driving School Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom scrollbar styling for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #10B981;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #F3F4F6;
        }
        .tab-content {
            min-height: 400px;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#10B981',
                        'secondary-gray': '#4B5563',
                        'light-gray': '#F9FAFB',
                    }
                },
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                }
            }
        }
    </script>
</head>
<body class="bg-light-gray font-sans min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="bg-white shadow-lg rounded-xl p-4 mb-6 flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-3xl font-extrabold text-primary-green tracking-tight mb-3 sm:mb-0">
                <i class="fas fa-car mr-2"></i> Driving School Manager
            </h1>
            <div class="flex items-center space-x-4">
                <div id="syncStatus" class="flex items-center text-sm font-medium text-secondary-gray">
                    <i class="fas fa-sync-alt mr-2 animate-spin text-yellow-500"></i>
                    <span>Syncing...</span>
                </div>
            </div>
        </header>

        <!-- Credentials Input Section -->
        <div id="credentials" class="bg-white p-6 shadow-lg rounded-xl mb-6 border border-red-300">
            <h2 class="text-xl font-semibold text-secondary-gray mb-4">Credentials & Setup <i class="fas fa-tools ml-2 text-blue-500"></i></h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="webAppUrl" class="block text-sm font-medium text-gray-700">Web App URL (For Writing)</label>
                    <input type="text" id="webAppUrl" placeholder="Enter your Google Apps Script Web App URL here" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-green focus:ring-primary-green p-2 border">
                    <p class="mt-1 text-xs text-gray-500">This URL is used to send payment data to Google Sheets.</p>
                </div>
                <div>
                    <label for="sheetUrl" class="block text-sm font-medium text-gray-700">Google Sheet URL (For Reading)</label>
                    <input type="text" id="sheetUrl" placeholder="Enter your main Google Sheet URL here" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-green focus:ring-primary-green p-2 border">
                    <p class="mt-1 text-xs text-gray-500">The Student data will be fetched from this sheet.</p>
                </div>
            </div>
            <button onclick="saveCredentialsAndReload()" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                Save Credentials and Reload
            </button>
        </div>

        <!-- Main Content Tabs -->
        <div id="mainContent" class="hidden">
            <div class="bg-white shadow-lg rounded-xl">
                <!-- Tab Headers -->
                <div class="flex border-b border-gray-200">
                    <button id="studentsTab" onclick="changeTab('students')" class="py-3 px-6 text-sm font-medium transition-colors duration-200 focus:outline-none rounded-tl-xl border-b-2 border-primary-green text-primary-green">
                        <i class="fas fa-users mr-2"></i> Students
                    </button>
                    <button id="paymentsTab" onclick="changeTab('payments')" class="py-3 px-6 text-sm font-medium transition-colors duration-200 focus:outline-none text-secondary-gray hover:text-primary-green">
                        <i class="fas fa-dollar-sign mr-2"></i> Payments
                    </button>
                    <button id="recordTab" onclick="changeTab('record')" class="py-3 px-6 text-sm font-medium transition-colors duration-200 focus:outline-none text-secondary-gray hover:text-primary-green">
                        <i class="fas fa-receipt mr-2"></i> Record Payment
                    </button>
                </div>

                <!-- Tab Contents -->
                <div class="p-6 tab-content overflow-auto">
                    <!-- Students Tab Content -->
                    <div id="studentsContent" class="tab-pane">
                        <h2 class="text-2xl font-semibold text-secondary-gray mb-4">Current Students</h2>
                        <div class="mb-4 flex flex-col sm:flex-row gap-3">
                             <input type="text" id="studentSearch" placeholder="Search by name or ID..." class="flex-grow rounded-lg border-gray-300 shadow-sm focus:border-primary-green focus:ring-primary-green p-2 border">
                             <button onclick="changeTab('addStudent')" class="bg-primary-green hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                                <i class="fas fa-plus mr-2"></i> Add New Student
                            </button>
                        </div>

                        <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-lg overflow-hidden">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fee</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                </tr>
                            </thead>
                            <tbody id="studentList" class="bg-white divide-y divide-gray-200">
                                <!-- Student rows will be injected here -->
                            </tbody>
                        </table>
                        <div id="studentStatus" class="mt-4 text-center text-secondary-gray">Loading student data...</div>
                    </div>

                    <!-- Payments Tab Content -->
                    <div id="paymentsContent" class="tab-pane hidden">
                        <h2 class="text-2xl font-semibold text-secondary-gray mb-4">Payment History</h2>
                        <input type="text" id="paymentSearch" placeholder="Search by Student ID or Name..." class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-green focus:ring-primary-green p-2 border mb-4">
                        <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-lg overflow-hidden">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paymentList" class="bg-white divide-y divide-gray-200">
                                <!-- Payment rows will be injected here -->
                            </tbody>
                        </table>
                         <div id="paymentStatus" class="mt-4 text-center text-secondary-gray">Loading payment data...</div>
                    </div>

                    <!-- Record Payment Tab Content -->
                    <div id="recordContent" class="tab-pane hidden max-w-lg mx-auto bg-gray-50 p-6 rounded-xl shadow-inner">
                        <h2 class="text-2xl font-semibold text-secondary-gray mb-6 text-center">Record New Payment</h2>

                        <div class="mb-4">
                            <label for="recordStudentId" class="block text-sm font-medium text-gray-700">Student ID or Name</label>
                            <select id="recordStudentId" onchange="updateRecordStudentDetails()" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-green focus:ring-primary-green p-2 border" required>
                                <option value="">Select a Student...</option>
                                <!-- Options populated by JavaScript -->
                            </select>
                            <p id="recordStudentDetails" class="mt-2 text-sm text-gray-500 italic"></p>
                        </div>

                        <div class="mb-4">
                            <label for="recordAmount" class="block text-sm font-medium text-gray-700">Amount Paid (RM)</label>
                            <input type="number" id="recordAmount" placeholder="e.g., 500.00" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-green focus:ring-primary-green p-2 border" step="0.01" required>
                        </div>

                        <div class="mb-6">
                            <label for="recordMethod" class="block text-sm font-medium text-gray-700">Payment Method</label>
                            <select id="recordMethod" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-green focus:ring-primary-green p-2 border" required>
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Credit Card">Credit Card</option>
                            </select>
                        </div>

                        <button onclick="recordPayment()" class="w-full bg-primary-green hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md flex items-center justify-center">
                            <i class="fas fa-check-circle mr-2"></i> Record New Payment & Generate Receipt
                        </button>
                        <div id="recordStatus" class="mt-4 text-center font-semibold"></div>
                    </div>

                    <!-- Add Student Tab Content -->
                     <div id="addStudentContent" class="tab-pane hidden max-w-lg mx-auto bg-gray-50 p-6 rounded-xl shadow-inner">
                        <h2 class="text-2xl font-semibold text-secondary-gray mb-6 text-center">Add New Student</h2>

                        <div class="mb-4">
                            <label for="addStudentName" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="addStudentName" placeholder="e.g., John Doe" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-green focus:ring-primary-green p-2 border" required>
                        </div>
                        <div class="mb-4">
                            <label for="addStudentPhone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                            <input type="tel" id="addStudentPhone" placeholder="e.g., 0123456789" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-green focus:ring-primary-green p-2 border" required>
                        </div>
                        <div class="mb-4">
                            <label for="addStudentCourse" class="block text-sm font-medium text-gray-700">Course Type</label>
                            <input type="text" id="addStudentCourse" placeholder="e.g., Full License Package" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-green focus:ring-primary-green p-2 border" required>
                        </div>
                        <div class="mb-6">
                            <label for="addStudentFee" class="block text-sm font-medium text-gray-700">Total Course Fee (RM)</label>
                            <input type="number" id="addStudentFee" placeholder="e.g., 2500.00" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-green focus:ring-primary-green p-2 border" step="0.01" required>
                        </div>

                        <button onclick="addStudent()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md flex items-center justify-center">
                            <i class="fas fa-user-plus mr-2"></i> Save New Student
                        </button>
                        <div id="addStudentStatus" class="mt-4 text-center font-semibold"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Modal/Message Box (Replaces alert/confirm) -->
    <div id="globalModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all">
            <h3 id="modalTitle" class="text-xl font-bold mb-4 text-secondary-gray">Alert</h3>
            <p id="modalMessage" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 bg-primary-green hover:bg-green-600 text-white rounded-lg font-medium transition duration-150">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS AND STATE ---
        let APPS_SCRIPT_URL = ''; // This will be set by the credential input
        let SHEET_URL = '';       // This will be set by the credential input
        let SPREADSHEET_ID = '';

        let allStudents = [];
        let allPayments = [];
        let currentTab = 'students';
        let isSyncing = true;

        // --- CREDENTIALS HANDLING ---

        function saveCredentialsAndReload() {
            const webAppUrl = document.getElementById('webAppUrl').value.trim();
            const sheetUrl = document.getElementById('sheetUrl').value.trim();

            if (webAppUrl && sheetUrl) {
                localStorage.setItem('APPS_SCRIPT_URL', webAppUrl);
                localStorage.setItem('SHEET_URL', sheetUrl);
                // Extract Spreadsheet ID from URL
                const match = sheetUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (match && match[1]) {
                    localStorage.setItem('SPREADSHEET_ID', match[1]);
                } else {
                     showModal('Error', 'Invalid Google Sheet URL format. Please ensure it is a standard URL containing the /d/{ID}/ part.');
                     return;
                }
                showModal('Success', 'Credentials saved! Reloading application...');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showModal('Error', 'Please enter both the Web App URL and the Google Sheet URL.');
            }
        }

        function loadCredentials() {
            APPS_SCRIPT_URL = localStorage.getItem('APPS_SCRIPT_URL') || '';
            SHEET_URL = localStorage.getItem('SHEET_URL') || '';
            SPREADSHEET_ID = localStorage.getItem('SPREADSHEET_ID') || '';

            document.getElementById('webAppUrl').value = APPS_SCRIPT_URL;
            document.getElementById('sheetUrl').value = SHEET_URL;

            if (APPS_SCRIPT_URL && SHEET_URL) {
                document.getElementById('credentials').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                fetchData();
            } else {
                document.getElementById('credentials').classList.remove('hidden');
                document.getElementById('mainContent').classList.add('hidden');
                updateSyncStatus('Ready to configure.', 'text-blue-500');
            }
        }

        // --- DATA FETCHING AND PROCESSING ---

        async function fetchData() {
            if (!SPREADSHEET_ID) {
                updateSyncStatus('Configuration missing.', 'text-red-500');
                return;
            }

            updateSyncStatus('Fetching data...', 'text-yellow-500', true);

            try {
                // Fetch student data
                const studentsResponse = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=Students`);
                const studentsText = await studentsResponse.text();
                allStudents = parseData(studentsText);

                // Fetch payment data
                const paymentsResponse = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=Payments`);
                const paymentsText = await paymentsResponse.text();
                allPayments = parseData(paymentsText);
                
                // Remove old, broken records
                allStudents = allStudents.filter(s => s.ID && s.ID.startsWith('S'));
                allPayments = allPayments.filter(p => p.PAYMENT_ID && p.PAYMENT_ID.startsWith('P'));

                // Enrich students with balance and total paid
                const studentPayments = allPayments.reduce((acc, p) => {
                    if (!acc[p.STUDENT_ID]) acc[p.STUDENT_ID] = 0;
                    // Use parseFloat here as amount might come as a string/number from the sheet
                    acc[p.STUDENT_ID] += parseFloat(p.AMOUNT) || 0; 
                    return acc;
                }, {});

                allStudents = allStudents.map(student => {
                    const totalPaid = studentPayments[student.ID] || 0;
                    const totalFee = parseFloat(student.TOTAL_FEE) || 0;
                    student.TOTAL_PAID = totalPaid;
                    student.BALANCE = totalFee - totalPaid;
                    return student;
                });

                renderStudents(allStudents);
                renderPayments(allPayments);
                populateRecordPaymentSelect(allStudents);

                updateSyncStatus('Sync Complete!', 'text-primary-green', false);

            } catch (error) {
                console.error("Error fetching or parsing data:", error);
                updateSyncStatus('Error fetching data. Check Sheet URL and Sharing settings.', 'text-red-500', false);
            }
        }

        // Standard Google Visualization API response parsing
        function parseData(text) {
            try {
                const jsonText = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
                const data = JSON.parse(jsonText);
                
                // Helper to sanitize column names for consistency
                const sanitizeColName = (name) => name.toUpperCase().replace(/\s+/g, '_').trim();

                const columns = data.table.cols.map(col => sanitizeColName(col.label));
                const rows = data.table.rows;

                return rows.map(row => {
                    const item = {};
                    row.c.forEach((cell, i) => {
                        const colName = columns[i]; // Use sanitized name
                        
                        if (cell === null || cell.v === null) {
                            item[colName] = '';
                            return;
                        }
                        
                        // Prioritize formatted value (f) for dates and display values
                        if (cell.f) {
                            item[colName] = cell.f.trim();
                        } else if (typeof cell.v === 'string') {
                            item[colName] = cell.v.trim();
                        } else if (typeof cell.v === 'number') {
                            item[colName] = cell.v;
                        } else if (typeof cell.v === 'object' && cell.v !== null) {
                            // Handle potential date objects which come as arrays/objects
                            if (colName.includes('DATE') && Array.isArray(cell.v)) {
                                item[colName] = new Date(cell.v[0], cell.v[1], cell.v[2]).toLocaleDateString();
                            } else {
                                item[colName] = cell.v;
                            }
                        } else {
                             item[colName] = '';
                        }
                    });
                    return item;
                });
            } catch (e) {
                console.error("Failed to parse data:", e, text);
                return [];
            }
        }

        // --- RENDERING FUNCTIONS ---

        function renderStudents(students) {
            const container = document.getElementById('studentList');
            if (!container) return;

            if (students.length === 0) {
                document.getElementById('studentStatus').textContent = 'No students found. Use "Add New Student" to begin.';
                container.innerHTML = '';
                return;
            }

            document.getElementById('studentStatus').textContent = '';
            container.innerHTML = students.map(s => {
                const totalFee = parseFloat(s.TOTAL_FEE) || 0;
                const balance = s.BALANCE || 0;
                const balanceColor = balance > 0 ? 'text-red-500' : 'text-primary-green';
                const balanceText = balance <= 0 ? 'Paid' : `RM ${balance.toFixed(2)}`;
                
                return `
                    <tr class="hover:bg-gray-50 transition-colors duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.ID || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.FULL_NAME || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.PHONE_NUMBER || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.COURSE_TYPE || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">RM ${totalFee.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${balanceColor}">${balanceText}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderPayments(payments) {
            const container = document.getElementById('paymentList');
            if (!container) return;

             if (payments.length === 0) {
                document.getElementById('paymentStatus').textContent = 'No payments found.';
                container.innerHTML = '';
                return;
            }

            document.getElementById('paymentStatus').textContent = '';
            container.innerHTML = payments.map(p => {
                // Find student by ID (using the normalized column name 'STUDENT_ID')
                const student = allStudents.find(s => s.ID === p.STUDENT_ID) || {FULL_NAME: 'Unknown Student'};
                
                const receiptUrl = p.RECEIPT_URL || '';
                const receiptButton = receiptUrl.startsWith('http')
                    ? `<button onclick="window.open('${receiptUrl}', '_blank')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-sm transition duration-150"><i class="fas fa-eye mr-1"></i> View Receipt</button>`
                    : `<span class="text-xs text-red-500">No Receipt Generated</span>`;

                return `
                    <tr class="hover:bg-gray-50 transition-colors duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.PAYMENT_ID || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.FULL_NAME}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.DATE || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-green font-semibold">RM ${parseFloat(p.AMOUNT).toFixed(2) || '0.00'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.PAYMENT_METHOD || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            ${receiptButton}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // --- TAB AND STATUS UTILITIES ---

        function changeTab(tabName) {
            currentTab = tabName;
            const tabs = ['students', 'payments', 'record', 'addStudent'];

            tabs.forEach(tab => {
                const button = document.getElementById(`${tab}Tab`);
                const content = document.getElementById(`${tab}Content`);

                if (button) {
                    // Only show tabs that have a corresponding button (i.e., hide 'addStudent' button)
                    if (tab === tabName) {
                        button.classList.add('border-primary-green', 'text-primary-green');
                        button.classList.remove('border-transparent', 'text-secondary-gray', 'hover:text-primary-green');
                    } else {
                        button.classList.remove('border-primary-green', 'text-primary-green');
                        button.classList.add('border-transparent', 'text-secondary-gray', 'hover:text-primary-green');
                    }
                }
                if (content) {
                    content.classList.toggle('hidden', tab !== tabName);
                }
            });
            // Special handling for Add Student: ensure it is shown when explicitly selected
            if (tabName === 'addStudent') {
                document.getElementById('addStudentContent').classList.remove('hidden');
                document.getElementById('studentsContent').classList.add('hidden');
            }
        }

        function updateSyncStatus(message, colorClass, isSpinning = false) {
            const statusDiv = document.getElementById('syncStatus');
            const icon = statusDiv.querySelector('i');
            const textSpan = statusDiv.querySelector('span');

            statusDiv.className = `flex items-center text-sm font-medium ${colorClass}`;
            // Use current text color for the spinner/icon color
            const iconColor = colorClass.includes('red') ? 'text-red-500' : (colorClass.includes('yellow') ? 'text-yellow-500' : 'text-primary-green');
            icon.className = `fas fa-sync-alt mr-2 ${isSpinning ? 'animate-spin' : ''} ${iconColor}`;
            textSpan.textContent = message;
        }

        // --- RECORD PAYMENT TAB LOGIC ---

        function populateRecordPaymentSelect(students) {
            const select = document.getElementById('recordStudentId');
            const selectedId = select.value;
            select.innerHTML = '<option value="">Select a Student...</option>';
            
            // Filter to ensure only valid student IDs are shown
            const validStudents = students.filter(s => s.ID && s.ID.startsWith('S')); 

            validStudents.forEach(s => {
                const option = document.createElement('option');
                option.value = s.ID;
                option.textContent = `${s.FULL_NAME || 'N/A'} (ID: ${s.ID})`;
                if (s.ID === selectedId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            updateRecordStudentDetails();
        }

        function updateRecordStudentDetails() {
            const studentId = document.getElementById('recordStudentId').value;
            const detailsElement = document.getElementById('recordStudentDetails');
            const amountInput = document.getElementById('recordAmount');

            if (!studentId) {
                detailsElement.textContent = 'Select a student to see course fee and balance.';
                amountInput.value = '';
                return;
            }

            const student = allStudents.find(s => s.ID === studentId);
            if (student) {
                const balance = student.BALANCE || 0;
                const totalFee = parseFloat(student.TOTAL_FEE) || 0;
                const totalPaid = student.TOTAL_PAID || 0;
                
                const balanceColor = balance > 0 ? 'text-red-600' : 'text-primary-green';
                
                detailsElement.innerHTML = `
                    **Fee:** RM ${totalFee.toFixed(2)} |
                    **Paid:** RM ${totalPaid.toFixed(2)} |
                    <span class="${balanceColor} font-bold">Balance: RM ${balance.toFixed(2)}</span>
                `;
                // Suggest remaining balance as default payment amount
                amountInput.value = balance > 0 ? balance.toFixed(2) : '0.00';
            } else {
                 detailsElement.textContent = 'Student data not found.';
            }
        }

        // --- SUBMISSION FUNCTIONS ---

        async function postDataToAppsScript(data) {
            if (!APPS_SCRIPT_URL) {
                showModal('Error', 'Web App URL is not configured. Please save credentials.');
                return { success: false, message: 'URL not configured' };
            }

            const statusElement = document.getElementById(data.action === 'add_student' ? 'addStudentStatus' : 'recordStatus');
            statusElement.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Processing request...';
            statusElement.classList.remove('text-red-500', 'text-primary-green');
            statusElement.classList.add('text-blue-500');

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(data) 
                });

                // Since we use 'no-cors', we cannot read the response body directly.
                // We assume success and force a data refresh to reflect changes from Apps Script.

                // Wait a moment for Apps Script to finish writing data before fetching
                await new Promise(resolve => setTimeout(resolve, 3000));

                statusElement.textContent = 'Success! Updating data.';
                statusElement.classList.remove('text-blue-500');
                statusElement.classList.add('text-primary-green');

                // Reload data to see the changes
                await fetchData();

                if (data.action === 'add_payment') {
                    showModal('Payment Recorded', 'Payment has been successfully recorded. Check the Payments tab shortly for the receipt URL.');
                    // Switch back to payments to view history
                    changeTab('payments');
                } else {
                     showModal('Student Added', 'New student has been successfully added to the system. You should see them in the Students list now.');
                     // Switch back to students
                     changeTab('students');
                }

                return { success: true };

            } catch (error) {
                console.error("Fetch error:", error);
                const errorMessage = `Error saving data via Apps Script: ${error.message}. Please check your Web App URL and Apps Script logs.`;
                statusElement.textContent = errorMessage;
                statusElement.classList.remove('text-blue-500', 'text-primary-green');
                statusElement.classList.add('text-red-500');
                showModal('Server Error', errorMessage);
                return { success: false, message: error.message };
            }
        }


        async function recordPayment() {
            const studentId = document.getElementById('recordStudentId').value;
            const amount = document.getElementById('recordAmount').value;
            const method = document.getElementById('recordMethod').value;
            const statusElement = document.getElementById('recordStatus');

            if (!studentId || !amount || !method) {
                showModal('Missing Fields', 'Please select a student, enter the amount, and choose a payment method.');
                return;
            }

            const amountFloat = parseFloat(amount);
            if (isNaN(amountFloat) || amountFloat <= 0) {
                 showModal('Invalid Amount', 'Please enter a valid amount greater than zero.');
                return;
            }

            const paymentData = {
                action: 'add_payment',
                studentId: studentId,
                amount: amountFloat.toFixed(2),
                method: method,
                date: new Date().toLocaleDateString('en-US') // Send simple date string
            };

            await postDataToAppsScript(paymentData);
            statusElement.innerHTML = '';
            document.getElementById('recordAmount').value = '';
        }

        async function addStudent() {
            const name = document.getElementById('addStudentName').value.trim();
            const phone = document.getElementById('addStudentPhone').value.trim();
            const course = document.getElementById('addStudentCourse').value.trim();
            const fee = document.getElementById('addStudentFee').value;
            const statusElement = document.getElementById('addStudentStatus');

            if (!name || !phone || !course || !fee) {
                showModal('Missing Fields', 'Please fill in all student details.');
                return;
            }

            const studentData = {
                action: 'add_student',
                fullName: name,
                phoneNumber: phone,
                courseType: course,
                totalFee: parseFloat(fee).toFixed(2),
            };

            await postDataToAppsScript(studentData);
            statusElement.innerHTML = '';
            // Clear inputs after successful submission
            document.getElementById('addStudentName').value = '';
            document.getElementById('addStudentPhone').value = '';
            document.getElementById('addStudentCourse').value = '';
            document.getElementById('addStudentFee').value = '';
        }


        // --- UTILITY: MODAL ---

        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('globalModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('globalModal').classList.add('hidden');
        }

        // --- INITIALIZATION ---
        window.onload = loadCredentials;

        // --- SEARCH FUNCTIONALITY ---
        document.getElementById('studentSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredStudents = allStudents.filter(s =>
                s.FULL_NAME.toLowerCase().includes(query) ||
                s.ID.toLowerCase().includes(query) ||
                s.PHONE_NUMBER.includes(query)
            );
            renderStudents(filteredStudents);
        });

        document.getElementById('paymentSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredPayments = allPayments.filter(p => {
                const student = allStudents.find(s => s.ID === p.STUDENT_ID) || { FULL_NAME: '' };
                return (
                    p.STUDENT_ID.toLowerCase().includes(query) ||
                    student.FULL_NAME.toLowerCase().includes(query)
                );
            });
            renderPayments(filteredPayments);
        });

    </script>
</body>
</html>
